(() => {
  const CONFIG = {
    githubJSON: "https://cdn.jsdelivr.net/gh/RuanGadea/auditoriox-locais@main/auditoriox-starter/data/locais.json",
    siteBase: "https://www.auditoriox.com"
  };

  function setMeta(name, content) {
    if (!content) return;
    let el = document.querySelector(`meta[name="${name}"]`);
    if (!el) { el = document.createElement('meta'); el.name = name; document.head.appendChild(el); }
    el.content = content;
  }
  function setOG(prop, content) {
    if (!content) return;
    let el = document.querySelector(`meta[property="${prop}"]`);
    if (!el) { el = document.createElement('meta'); el.setAttribute('property', prop); document.head.appendChild(el); }
    el.content = content;
  }
  function setCanonical(href) {
    if (!href) return;
    let link = document.querySelector('link[rel="canonical"]');
    if (!link) { link = document.createElement('link'); link.rel = 'canonical'; document.head.appendChild(link); }
    link.href = href;
  }
  function addJSONLD(obj) {
    if (!obj) return;
    const s = document.createElement('script');
    s.type = 'application/ld+json';
    s.text = JSON.stringify(obj);
    document.head.appendChild(s);
  }
  function escapeHTML(s) {
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function hydrate(d) {
    document.title = d.seo_title || `${d.nome} | AuditÃ³rioX`;
    setMeta('description', d.seo_description || '');
    const ogImg = (d.og_image || '').split('|').map(s => s.trim()).filter(Boolean)[0] || d.og_image || '';
    setOG('og:title', d.seo_title || d.nome || '');
    setOG('og:description', d.seo_description || '');
    setOG('og:image', ogImg);
    setOG('og:type', 'website');
    setOG('og:url', `${CONFIG.siteBase}/locais/${d.slug}`);
    setMeta('twitter:card', 'summary_large_image');
    setCanonical(`${CONFIG.siteBase}/locais/${d.slug}`);

    document.querySelectorAll('[data-field]').forEach(function(el){
      const key = el.getAttribute('data-field');
      if (!key) return;
      if (key === 'fotos' && d.fotos) {
        const imgs = d.fotos.split('|').map(u => u.trim()).filter(Boolean);
        el.innerHTML = imgs.map(u => `<img src="${u}" alt="${escapeHTML(d.nome || 'Foto')}" loading="lazy">`).join('');
        return;
      }
      if (key === 'amenities' && d.amenities) {
        el.innerHTML = d.amenities.split(',').map(a => `<li>${escapeHTML(a.trim())}</li>`).join('');
        return;
      }
      const value = d[key];
      if (el.tagName === 'IMG') { if (value) el.setAttribute('src', value); }
      else { el.textContent = value || ''; }
    });

    var book = document.querySelector('[data-action="book"]');
    if (book) {
      if (d.simplybook_url) book.href = d.simplybook_url;
      else if (d.simplybook_service_id && d.simplybook_company_url)
        book.href = d.simplybook_company_url.replace(/\/+$/,'') + '/v2/#book/service/' + d.simplybook_service_id;
    }
    var pay = document.querySelector('[data-action="pay"]');
    if (pay && d.infinitepay_url) pay.href = d.infinitepay_url;
    var whats = document.querySelector('[data-action="whats"]');
    if (whats && d.whatsapp) {
      var digits = String(d.whatsapp).replace(/\D/g, '');
      if (digits) whats.href = 'https://wa.me/' + digits;
    }

    var imagesForLd = (d.og_image || '').split('|').map(s => s.trim()).filter(Boolean);
    addJSONLD({
      "@context":"https://schema.org",
      "@type":"LocalBusiness",
      "name": d.nome,
      "url": `${CONFIG.siteBase}/locais/${d.slug}`,
      "image": imagesForLd.length ? imagesForLd : undefined,
      "address": {"@type":"PostalAddress","streetAddress": d.endereco,"addressLocality": d.cidade,"addressRegion": d.uf,"postalCode": d.cep,"addressCountry":"BR"},
      "geo": (d.lat && d.lng) ? {"@type":"GeoCoordinates","latitude": +d.lat, "longitude": +d.lng} : undefined,
      "telephone": d.whatsapp || undefined,
      "priceRange": d.preco_min ? `R$ ${d.preco_min}+` : undefined,
      "amenityFeature": (d.amenities || '').split(',').filter(Boolean).map(a => ({"@type":"LocationFeatureSpecification","name": a.trim()}))
    });

    window.AX_DATA = d;
    document.dispatchEvent(new CustomEvent('ax:hydrated', { detail: d }));
  }

  function show404(){ var c = document.querySelector('[data-when="notfound"]'); if (c) c.style.display = 'block'; }
  function getSlug(){
    var params = new URLSearchParams(location.search);
    var fromQuery = (params.get('l') || '').toLowerCase();
    if (fromQuery) return fromQuery;
    var seg = location.pathname.split('/').filter(Boolean).pop();
    return (seg || '').toLowerCase();
  }
  function fetchJSON(url){
    return fetch(url, { cache: 'no-store' }).then(function(res){
      if (!res.ok) throw new Error('JSON not reachable');
      return res.json();
    });
  }

  function run(){
    var slug = getSlug();
    if (!slug) { show404(); return; }
    if (!CONFIG.githubJSON) { show404(); return; }
    fetchJSON(CONFIG.githubJSON).then(function(list){
      if (!Array.isArray(list)) { show404(); return; }
      var d = list.find(function(x){ return (x.slug || '').toLowerCase() === slug; });
      if (d) hydrate(d); else show404();
    }).catch(function(err){
      console.warn('Falha ao buscar JSON do GitHub/jsDelivr:', err);
      show404();
    });
  }

  if (document.readyState !== 'loading') run();
  else document.addEventListener('DOMContentLoaded', run);
})();
